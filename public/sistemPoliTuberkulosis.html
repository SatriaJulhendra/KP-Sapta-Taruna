<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <title>Sistem Poli Tuberkulosis</title>
    <link rel="shortcut icon" href="https://firebasestorage.googleapis.com/v0/b/tugas-akhir-kp.appspot.com/o/logo%20pusesmas.png?alt=media&token=538e6489-a997-4ede-a6ed-68c88bcae138&_gl=1*b2874e*_ga*MTQ3MDYwMDM0OS4xNjk3NzU0Nzc2*_ga_CW55HF8NVT*MTY5OTAyMjQ2Ny4xNS4xLjE2OTkwMjUyODAuMTYuMC4w" type="image/x-icon">
    <link rel="stylesheet" href="sistemPoli.css">
</head>
<body>
    <nav>
        <div class="navigasi">
            <a href="index.html"><img src="asset/logo-puskesmas.png" alt="" class="pkm-logo"></a>
            <div class="navigasi-items">
                <img src="asset/profil-icon.png" alt="">
                <p>Poli Tuberkulosis</p>
            </div>
        </div>
    </nav>

    <section>
        <div class="poli">
            <div class="poli-items">
                <h1>POLI TUBERKULOSIS</h1>
                <div class="underline"><p></p></div>
            </div>
            <div class="daftar">
                <div class="daftar-pasien">
                    <h1>Semua Pasien</h1>
                </div>
                <div id="tabel-container">
                    <script>
                        const app = firebase.initializeApp({
                            apiKey: "AIzaSyAPNUyW3s59eL_VJ-ZsdBGhK4bSPfeFj68",
                            authDomain: "pkm-poli.firebaseapp.com",
                            projectId: "pkm-poli",
                            storageBucket: "pkm-poli.appspot.com",
                            messagingSenderId: "923270174053",
                            appId: "1:923270174053:web:94757b3a1feecb304abd8c",
                            measurementId: "G-MT3J72X28P"
                        });
                    
                        const db = app.firestore();
                    
                        const container = document.getElementById('tabel-container');
                    
                        // Tambahkan variabel global untuk mengingat mode edit
                        let isEditMode = false;
                        let currentDocId = null; // ID dokumen yang sedang diedit
                    
                        // Fungsi untuk masuk ke mode edit
                        function enterEditMode(docId) {
                            isEditMode = true;
                            currentDocId = docId;
                            // Nonaktifkan input yang tidak perlu diedit
                            document.getElementById('namaPasien').disabled = true;
                            document.getElementById('tempatLahir').disabled = true;
                            document.getElementById('jenisKelamin').disabled = true;
                            document.getElementById('riwayatPenyakit').disabled = true;
                            document.getElementById('keluhan').disabled = true;
                            // Tampilkan textarea untuk diagnosa, resep, dan saran
                            document.getElementById('textareaDiagnosa').style.display = 'block';
                            document.getElementById('textareaResep').style.display = 'block';
                            document.getElementById('textareaSaran').style.display = 'block';
                            document.getElementById('rujukanRadio').style.display = 'block';
                            document.getElementById('rujukanLokasi').style.display = 'block';
                            document.getElementById('rujukanAlasan').style.display = 'block';
                            // Tampilkan tombol "Kirim"
                            document.getElementById('kirimButton').style.display = 'block';
                        }
                    
                        // Fungsi untuk keluar dari mode edit
                        function exitEditMode() {
                            isEditMode = false;
                            currentDocId = null;
                            // Aktifkan kembali input yang dinonaktifkan
                            document.getElementById('namaPasien').disabled = false;
                            document.getElementById('tempatLahir').disabled = false;
                            document.getElementById('jenisKelamin').disabled = false;
                            document.getElementById('riwayatPenyakit').disabled = true;
                            document.getElementById('keluhan').disabled = true;
                            // Sembunyikan textarea diagnosa, resep, dan saran
                            document.getElementById('textareaDiagnosa').style.display = 'none';
                            document.getElementById('textareaResep').style.display = 'none';
                            document.getElementById('textareaSaran').style.display = 'none';
                            document.getElementById('rujukan').style.display = 'none';
                            document.getElementById('rujukanLokasi').style.display = 'none';
                            document.getElementById('rujukanAlasan').style.display = 'none';
                            // Sembunyikan tombol "Kirim"
                            document.getElementById('kirimButton').style.display = 'none';
                        }
                    
                        // Fungsi untuk menyimpan perubahan ke Firebase Firestore
                        async function saveChanges() {
                            const diagnosa = document.getElementById('textareaDiagnosa').value;
                            const resep = document.getElementById('textareaResep').value;
                            const saran = document.getElementById('textareaSaran').value;

                            // Validasi textarea hanya mengandung huruf (minimal satu huruf)
                            const hurufRegex = /[a-zA-Z]/;
                            if (
                                currentDocId &&
                                (hurufRegex.test(diagnosa) || hurufRegex.test(resep)) &&
                                validateRujukan()
                            ) {
                                // Simpan diagnosa dan resep ke dokumen Firebase
                                await db.collection('Pasien Tuberkulosis').doc(currentDocId).update({
                                    Diagnosa: diagnosa,
                                    Resep: resep,
                                    Saran: saran,
                                });

                                // Hapus elemen HTML terkait
                                const table = document.querySelector(`[data-doc-id="${currentDocId}"]`);
                                if (table) {
                                    table.remove();
                                }

                                // Hapus dokumen dari Firebase Firestore
                                await db.collection('Pasien Tuberkulosis').doc(currentDocId).delete();

                                alert('Perubahan berhasil disimpan dan dikirim ke Apotek!');
                                // Keluar dari mode edit
                                exitEditMode();
                            } else {
                                alert('Mohon melengkapi semua data pemeriksaan sebelum mengirim ke Apotek.');
                            }
                        }

                        // Fungsi untuk validasi rujukan
                        function validateRujukan() {
                            const radioDirujuk = document.getElementById('radioDirujuk');
                            const radioTidakDirujuk = document.getElementById('radioTidakDirujuk');
                            const lokasiRujukan = document.getElementById('lokasiRujukan').value;
                            const alasanRujukan = document.getElementById('alasanRujukan').value;

                            // Validasi radio button
                            if (!(radioDirujuk.checked || radioTidakDirujuk.checked)) {
                                alert('Mohon pilih apakah perlu dirujuk atau tidak.');
                                return false;
                            }

                            // Validasi input lokasi dan alasan rujukan (jika dirujuk)
                            if (radioDirujuk.checked && (!lokasiRujukan.trim() || !alasanRujukan.trim())) {
                                alert('Mohon isi lokasi dan alasan rujukan jika perlu dirujuk.');
                                return false;
                            }

                            return true;
                        }

                        // Fungsi untuk menangani peristiwa tombol di dalam textarea
                        function handleKeyDown(event) {
                            // Jika tombol Enter ditekan
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                insertBulletPoint();
                            }
                        }

                        // Fungsi untuk menambahkan tanda strip pada posisi kursor
                        function insertBulletPoint() {
                            const textarea = document.activeElement;
                            const cursorPosition = textarea.selectionStart;

                            // Mendapatkan teks sebelum dan sesudah posisi kursor
                            const textBeforeCursor = textarea.value.substring(0, cursorPosition);
                            const textAfterCursor = textarea.value.substring(cursorPosition);

                            // Menambahkan tanda strip pada posisi kursor dan mengganti nilai textarea
                            textarea.value = textBeforeCursor + '\n- ' + textAfterCursor;

                            // Mengatur posisi kursor setelah tanda strip yang baru ditambahkan
                            textarea.setSelectionRange(cursorPosition + 3, cursorPosition + 3);
                        }
                        
                        db.collection('Pasien Tuberkulosis').onSnapshot((snapshot) => {
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                    
                                // Create a new table for each data
                                const table = document.createElement('table');
                                table.innerHTML = `
                                    <tr>
                                        <th>Nama Pasien</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><span id="namaPasien">${data["Nama Pasien"]}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Tempat, Tanggal Lahir</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><span id="tempatLahir">${data["Tempat, Tanggal Lahir"]}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Jenis Kelamin</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><span id="jenisKelamin">${data["Jenis Kelamin"]}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Riwayat Penyakit</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><span id="riwayatPenyakit">${data["Riwayat Penyakit"]}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Keluhan Saat Ini</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><span id="keluhan">${data["Keluhan saat ini"]}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Diagnosa</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><textarea id="textareaDiagnosa" ${isEditMode ? "style='display: block;'" : "style='display: none;'"} onkeydown="handleKeyDown(event)">- ${data["Diagnosa"] ? data["Diagnosa"] : ''}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th>Resep</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><textarea id="textareaResep" ${isEditMode ? "style='display: block;'" : "style='display: none;'"} onkeydown="handleKeyDown(event)">- ${data["Resep"] ? data["Resep"] : ''}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th>Apakah perlu dirujuk?</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field" id="rujukanRadio" ${isEditMode ? "style='display: block;'" : "style='display: none;'"}>
                                            <label>
                                                <input type="radio" name="rujukan" id="radioDirujuk" value="Ya"> Ya
                                            </label>
                                            <label>
                                                <input type="radio" name="rujukan" id="radioTidakDirujuk" value="Tidak"> Tidak
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <td></td>
                                        <td class="detail-field" id="rujukanLokasi" ${isEditMode ? "style='display: block;'" : "style='display: none;'"}>
                                            <label class="labelRujukan">Jika Ya, masukkan lokasi dan alasan/tujuan rujukan dilakukan</label>
                                            <input type="text" id="lokasiRujukan" placeholder="Kemana pasien dirujuk?">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <td></td>
                                        <td class="detail-field" id="rujukanAlasan" ${isEditMode ? "style='display: block;'" : "style='display: none;'"}>
                                            <input type="text" id="alasanRujukan" placeholder="Mengapa pasien perlu dirujuk?">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Saran Dokter</th>
                                        <td class="col-titik-dua">:</td>
                                        <td class="detail-field"><textarea id="textareaSaran" ${isEditMode ? "style='display: block;'" : "style='display: none;'"} onkeydown="handleKeyDown(event)">- ${data["Saran"] ? data["Saran"] : ''}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <td></td>
                                        <td class="detail-field">
                                            <button id="kirimButton" style="${isEditMode ? 'display: block;' : 'display: none;'}" onclick="saveChanges()">Kirim</button>
                                        </td>
                                    </tr>
                                `;
                    
                                // Append the new table to the container
                                container.appendChild(table);
                    
                                // Menambahkan event listener untuk mengaktifkan mode edit
                                table.addEventListener('click', () => {
                                    if (!isEditMode) {
                                        enterEditMode(doc.id);
                                    }
                                });
                            });
                        });
                    </script>
                </div>
                <div class="kembali-button">
                    <a href="index.html" id="kembaliButton" style="text-decoration: none;">Kembali</a>
                </div>
            </div>
        </div>
    </section>
</body>
</html>